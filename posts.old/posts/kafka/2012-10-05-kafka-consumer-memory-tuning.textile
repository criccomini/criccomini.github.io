<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Kafka Consumer Memory Tuning</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        
        <link rel="stylesheet" href="/css/normalize.css">
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="/css/blog.css">
        <script src="/js/vendor/modernizr-2.6.1.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        
        <div class="content">
          <div class="col">
            <div class="text-blob" style="background-color: #34424D; color: white;">
              <div style="font-size: 2em; text-align: center;">
                <a style="color: white; text-decoration: none;" href="/">riccomini.name</a>
              </div>
            </div>
            <div class="text-blob">
              <a title="BlackBerry Storm, GPS, etc." href="/posts/blackberry">BlackBerry</a> <span style="color: #bbb;">7</span><br/>
              <a title="Data visualization and infographics" href="/posts/data-visualization">Data Visualization</a> <span style="color: #bbb;">1</span><br/>
              <a title="iPhone, Python, Operations, and Sports" href="/posts/game-time-baby">Game Time, Baby!</a> <span style="color: #bbb;">1</span><br/>
              <a title="Hadoop, Map/Reduce, Pig, and Hive" href="/posts/hadoop">Hadoop</a> <span style="color: #bbb;">5</span><br/>
              <a title="iPhone Objective C, and tutorials" href="/posts/iphone">iPhone</a> <span style="color: #bbb;">2</span><br/>
              <a title="Kafka, stream processing, Storm, and S4" href="/posts/kafka">Kafka</a> <span style="color: #bbb;">1</span><br/>
              <a title="Linux, and BASH" href="/posts/linux">Linux</a> <span style="color: #bbb;">1</span><br/>
              <a title="Python, PyFacebook, and Google App Engine" href="/posts/python">Python</a> <span style="color: #bbb;">1</span><br/>
              <a title="Twitter, Facebook, and LinkedIn" href="/posts/social">Social</a> <span style="color: #bbb;">5</span>
            </div>
            <div class="text-blob">
              <h4>Who</h4>

              <p>I am a software engineer in Silicon Valley.</p>

              <h4>About</h4>

              <p>My interests include distributed computing, data mining, programming, data visualization, and the social web.</p>
            </div>
            <div class="text-blob">
              <a href="/rss.xml"><img src="/img/rss.png"/></a>
              <a href="http://www.linkedin.com/in/riccomini"><img src="/img/linkedin.png"/></a>
              <a href="http://twitter.com/criccomini"><img src="/img/twitter.png"/></a>
              <a href="http://github.com/criccomini"><img src="/img/github.png"/></a>
            </div>
            
          </div>
          <div class="two-col">
            <div class="text-blob">
  <h2 style="color: #2E8AD1;">Kafka Consumer Memory Tuning</h2>
  <div style="font-size: .7em; color: #bbb;">05 Oct 2012</div>
  Kafka consumers have a somewhat nuanced memory footprint due to buffering. I'll go over memory tuning for consumers to prevent out of memory exceptions.
  Yesterday, I had a process that was consuming a single Kafka topic. I was running it in our "staging" environment, and everything worked great. My heap space for the process was set to 512 megabytes (-Xmx512M). When I moved this process to production, my process would fail with an out of memory exception. I was seeing:

bc. java.lang.OutOfMemoryError: Java heap space
BoundedByteBufferReceive [ERROR] OOME with size 4800026
java.lang.OutOfMemoryError: GC overhead limit exceeded
FetcherRunnable [ERROR] error in FetcherRunnable

Let's review what happened, and how to fix it.

h5. BUFFERS

When you create a Kafka consumer, you first instantiate a Kafka connector ("ConsumerConnector.scala":https://github.com/kafka-dev/kafka/blob/master/core/src/main/scala/kafka/consumer/ConsumerConnector.scala). Then, you create multiple threads that feed off of one or more topics:

bc. // create 4 partitions of the stream for topic "test", to allow 4 threads to consume
Map<String, List<KafkaStream<Message>>> topicMessageStreams = 
    consumerConnector.createMessageStreams(ImmutableMap.of("test", 4));
List<KafkaStream<Message>> streams = topicMessageStreams.get("test");

Internally, Kafka creates a buffer for each thread attached to the ConsumerConnector. In this case, there are four threads, and therefore four buffers. These buffers, which are queues, are populated asynchronously until they are "full". When your code reads from a stream, Kafka dequeues from the stream/thread's queue, and gives you a message. 

h5. TUNING MEMORY USAGE

Two important questions arise from this:

# When are the queues full?
# What are the queues populated with?

A queue is full when it reaches the configured maximum queue size (queuedchunks.max). That is, if queuedchunks.max=10, then the queue will be full when 10 objects are in it.

This leads me to question number two: What are these objects that the queue is populated with? It turns out, *they are not messages*. Instead, they are fetched byte buffers that contain *multiple messages*. The size of these byte buffers is determined by the configuration parameter: fetch.size.

So, to calculate how much memory your consumer is going to take, you have to use this formula:

bc. (number of consumer threads) * (queuedchunks.max) * (fetch.size)

For example, if you have 24 threads, a max queue size of 10, and a fetch.size of 1.2 megabytes, your consumer is going to take 288 megabytes of heap space (24 threads * 10 fetches * 1.2 megabytes/fetch) if all queues are full.

If you run out of space, you have a few options: increase heap space, reduce your consumer threads, or lower your fetch size or max queue size. Obviously, different tunings have different affects on your throughput. With fewer buffers, or fewer fetches per queue, you might negatively impact your throughput.

h5. WHAT HAPPENED TO MY PROCESS

The number of threads in my process was dependent on how many partitions the topic had that I was consuming from. When I moved from staging to production, the Kafka cluster I was consuming from had far more brokers, and far more partitions per topic. As a result, the memory footprint of my process drastically changed. I went from 22 threads to 32, which changed my heap usage from 264 megabytes to 384 megabytes. This was enough to set my process' total memory usage over 512 megabytes, which caused the out of memory exceptions.
</div>

<div class="text-blob">
  <div>
    <div style="float: right;">
      
      <a href="/posts.old/posts/hadoop/2012-10-12-hortonworks-yarn-meetup" title="On Friday, I presented, "Building Applications on YARN," at the Apache YARN meet-up at Hortonworks. This post contains my slides, as well as notes about the meet-up.">Hortonworks YARN Developer Meetup Notes (October '12) &raquo; </a>
      
    </div>
    
    <div>
      
      <a href="/posts.old/posts/game-time-baby/2012-09-29-streaming-live-sports-schedule-scores-stats-api" title="One of my side projects ("Game Time, Baby!":http://getgametimebaby.com) required a way to programmatically load realtime live sports scores and schedules via an API. This page contains a rundown of the various options and services available.">&laquo; Schedules & Scores API for Streaming Live Sports Stats</a>
      
    </div>
  </div>
</div>


          </div>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.8.0.min.js"><\/script>')</script>
        <script src="/js/plugins.js"></script>
        <script src="/js/main.js"></script>

        
    </body>
</html>
