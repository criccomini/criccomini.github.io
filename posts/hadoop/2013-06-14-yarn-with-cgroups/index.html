<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Using YARN with Cgroups</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        
        <link rel="stylesheet" href="/css/normalize.css">
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="/css/blog.css">
        <script src="/js/vendor/modernizr-2.6.1.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        
        <div class="content">
          <div class="col">
            <div class="text-blob" style="background-color: #34424D; color: white;">
              <div style="font-size: 2em; text-align: center;">
                <a style="color: white; text-decoration: none;" href="/">riccomini.name</a>
              </div>
            </div>
            <div class="text-blob">
              <a title="BlackBerry Storm, GPS, etc." href="/posts/blackberry">BlackBerry</a> <span style="color: #bbb;">7</span><br/>
              <a title="Data visualization and infographics" href="/posts/data-visualization">Data Visualization</a> <span style="color: #bbb;">1</span><br/>
              <a title="iPhone, Python, Operations, and Sports" href="/posts/game-time-baby">Game Time, Baby!</a> <span style="color: #bbb;">1</span><br/>
              <a title="Hadoop, Map/Reduce, Pig, and Hive" href="/posts/hadoop">Hadoop</a> <span style="color: #bbb;">5</span><br/>
              <a title="iPhone Objective C, and tutorials" href="/posts/iphone">iPhone</a> <span style="color: #bbb;">2</span><br/>
              <a title="Kafka, stream processing, Storm, and S4" href="/posts/kafka">Kafka</a> <span style="color: #bbb;">1</span><br/>
              <a title="Linux, and BASH" href="/posts/linux">Linux</a> <span style="color: #bbb;">1</span><br/>
              <a title="Python, PyFacebook, and Google App Engine" href="/posts/python">Python</a> <span style="color: #bbb;">1</span><br/>
              <a title="Twitter, Facebook, and LinkedIn" href="/posts/social">Social</a> <span style="color: #bbb;">5</span>
            </div>
            <div class="text-blob">
              <h4>Who</h4>

              <p>I am a software engineer in Silicon Valley.</p>

              <h4>About</h4>

              <p>My interests include distributed computing, data mining, programming, data visualization, and the social web.</p>
            </div>
            <div class="text-blob">
              <a href="/rss.xml"><img src="/img/rss.png"/></a>
              <a href="http://www.linkedin.com/in/riccomini"><img src="/img/linkedin.png"/></a>
              <a href="http://twitter.com/criccomini"><img src="/img/twitter.png"/></a>
              <a href="http://github.com/criccomini"><img src="/img/github.png"/></a>
            </div>
            
          </div>
          <div class="two-col">
            <div class="text-blob">
  <h2 style="color: #2E8AD1;">Using YARN with Cgroups</h2>
  <div style="font-size: .7em; color: #bbb;">14 Jun 2013</div>
  <p>One of YARN&#8217;s exciting new features is its support for Cgroups in <span class="caps">YARN</span> containers. This post shows how to setup and use Cgroups with <span class="caps">YARN</span> 2.0.5-alpha.</p>
  <h5>Introduction</h5>
<p>I&#8217;m still a novice with Cgroups, but I thought it would be worth documenting how to set <span class="caps">YARN</span> up with them, since there seems to be a surprising lack of documentation on how to get this stuff going. I&#8217;m going to show you how to:</p>

	<ol>
		<li>Check if Cgroups is installed on your machine</li>
		<li>Configure <span class="caps">YARN</span> to run use Cgroups</li>
	</ol><p>Note that this tutorial is written based on a <span class="caps">RHEL</span> 6 environment. You won&#8217;t be able to use the CGroup features unless you&#8217;re on Linux.</p>
<h5>What are Cgroups?</h5>
<p>Cgroups are a Linux kernel module that allow you to control resource usage (<span class="caps">CPU</span>, disk, etc) at a per-process level, to provide performance guarantees when running in a shared environment.</p>
<p>The two best places to get a high level view of Cgroups are:</p>

	<ul>
		<li><a href="https://www.kernel.org/doc/Documentation/cgroups/cgroups.txt">https://www.kernel.org/doc/Documentation/cgroups/cgroups.txt</a></li>
		<li><a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/pdf/Resource_Management_Guide/Red_Hat_Enterprise_Linux-6-Resource_Management_Guide-en-US.pdf">Red Hat Enterprise Linux 6 Resource Management Guide</a></li>
		<li><a href="https://wiki.archlinux.org/index.php/Cgroups">https://wiki.archlinux.org/index.php/Cgroups</a></li>
		<li><a href="http://en.wikipedia.org/wiki/Cgroups">http://en.wikipedia.org/wiki/Cgroups</a></li>
	</ul><p><strong>You should definitely read the first two documents, which are the kernel documentation, and <span class="caps">RHEL</span> 6 documentation for Cgroups. The remainder of the post assumes you&#8217;ve read these documents.</strong></p>
<p>Currently (as of 2.0.5-alpha), <span class="caps">YARN</span> only supports Cgroups <span class="caps">CPU</span> isolation (using a property called cpu.shares, which I&#8217;ll get into later). There are future plans to add more features to the <span class="caps">CPU</span> isolation (in 2.1.0-beta; <a href="https://issues.apache.org/jira/browse/YARN-600"><span class="caps">YARN</span>-610</a>, <a href="https://issues.apache.org/jira/browse/YARN-799"><span class="caps">YARN</span>-799</a>, <a href="https://issues.apache.org/jira/browse/YARN-810"><span class="caps">YARN</span>-810</a>), and also support other resources, such as disk, and network.</p>
<h5>Setting up Cgroups</h5>
<p>Cgroups is fairly OS-specific, so you&#8217;ll need to do research into whether your particular OS and Kernel have Cgroups setup and installed. For this tutorial, I used <span class="caps">RHEL</span> 6 with the following kernel:</p>
<script src="https://gist.github.com/5784586.js"> </script><p>Ubuntu also has Cgroup support rolled into it (See <a href="http://www.docker.io/">Docker</a>). You can verify whether Cgroups is installed by checking if /proc/cgroups exists.</p>
<script src="https://gist.github.com/5784621.js"> </script><p>Another way to check if Cgroups exist is by looking for the mount point where Cgroups end up. In <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/pdf/Resource_Management_Guide/Red_Hat_Enterprise_Linux-6-Resource_Management_Guide-en-US.pdf"><span class="caps">RHEL</span> 6</a>, this defaults to /cgroup. The mount point might also be in /sys/fs/cgroup on other setups.</p>
<p>You&#8217;ll probably also want to install libcgroup, which comes with some handy tools (as mentioned in the <span class="caps">RHEL</span> 6 documents, linked above).</p>
<script src="https://gist.github.com/5784697.js"> </script><p>Finally, you&#8217;ll want to setup a <span class="caps">CPU</span> directory inside the Cgroup root folder (if one doesn&#8217;t already exist), so <span class="caps">YARN</span> can use it to mount its <span class="caps">CPU</span> hierarchies.</p>
<script src="https://gist.github.com/5784740.js"> </script><p>Once you&#8217;ve established that Cgroups is installed (or installed it), and configured the <span class="caps">CPU</span> directory, it&#8217;s time to setup YARN&#8217;s NM and RM to use it.</p>
<h5>Setting up <span class="caps">YARN</span> with Cgroups</h5>
<p>To use <span class="caps">YARN</span> with CGroups, all you really need to do is configure it to use the LinuxContainerExecutor (<span class="caps">LCE</span>), instead of the DefaultContainerExecutor, that ships with it out of the box. Once you configure the <span class="caps">LCE</span>, you just need to flip a few switches to get the <span class="caps">LCE</span> using Cgroups.</p>
<p><strong>To setup <span class="caps">LCE</span> for <span class="caps">YARN</span>, start by reading <a href="http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/ClusterSetup.html">Hadoop MapReduce Next Generation &#8211; Cluster Setup</a>.</strong></p>
<p>In your yarn-site.xml, you need to add the following configurations:</p>
<script src="https://gist.github.com/5784750.js"> </script><p>Make sure to set the last configuration value according to the group that your <span class="caps">YARN</span> users will run under (e.g. hadoop).</p>
<p>You&#8217;ll probably also want to configure the <span class="caps">YARN</span> NM to support more than one virtual core. By default, the NM only allows one virtual core to be used.</p>
<script src="https://gist.github.com/5784838.js"> </script><p>All this is doing is mapping some number of virtual cores to your machine&#8217;s physical cores. This is useful because it lets you run different kinds of machines in the same <span class="caps">YARN</span> cluster (e.g. some with CPUs that are 2x as fast as others), and still have a standard &#8220;core&#8221; that developers can use to reason about how much <span class="caps">CPU</span> they need.</p>
<p>Setup your container-executor, and container-executor.cfg file (see the <a href="http://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/ClusterSetup.html">ClusterSetup</a> link for details):</p>
<script src="https://gist.github.com/5785070.js"> </script><p>Finally, if you&#8217;re running <span class="caps">YARN</span> 2.0.5-beta, or prior, you&#8217;ll need to patch your hadoop-yarn-server-nodemanager-2.0.5-alpha.jar with <a href="https://issues.apache.org/jira/browse/YARN-600"><span class="caps">YARN</span>-600</a>, which actually updates cpu.shares with the proper percentage.</p>
<p>Now, when you turn on the <span class="caps">YARN</span> RM and NM, your jobs can use Cgroups!</p>
<script src="https://gist.github.com/5784890.js"> </script><h5>Example</h5>
<p>By default, containers will use one virtual core, which means that they&#8217;ll all get /cgroup/cpu/hadoop-yarn/container_id/cpu.shares set to 1024. You can experiment with these files pretty easily, and see how Cgroups works.</p>
<p>Start a single <span class="caps">YARN</span> container. Make the code in this containers just spin to waste <span class="caps">CPU</span>. I was having my containers hash random strings in a loop.</p>
<script src="https://gist.github.com/5784924.js"> </script><p>When you run `top`, you should see that the process is using nearly 100% of a single core. This might be surprising to you if you&#8217;re running more than one virtual core per physical core. For example, if you had a pcore:vcore ratio of 1:2, wouldn&#8217;t you expect a single container to get at most 50% of a core? As it turns out, Cgroups defaults to being optimistic. It lets you use as much <span class="caps">CPU</span> is available, and only begins throttling things back when the <span class="caps">CPU</span> is 100% utilized. Have a look at this <a href="http://lwn.net/Articles/336127/"><span class="caps">RFC</span></a> for details. This can be changed using Linux&#8217;s completely fair scheduler (see <a href="https://issues.apache.org/jira/browse/YARN-810"><span class="caps">YARN</span>-810</a>).</p>
<p>To continue the test, run 1 more container than you have cores on your machine (in this example, my machine has 8 cores, so I run a total of 9 containers). When you run `top`, you should see that all processes are fighting for <span class="caps">CPU</span> with roughly the same <span class="caps">CPU</span> usage for each process.</p>
<p>To activate Cgroups manually, run this command for one of your containers:</p>
<script src="https://gist.github.com/5784941.js"> </script><p>What we&#8217;ve just done is assign a very small fraction of the total <span class="caps">CPU</span> available to the <span class="caps">YARN</span> NM (10 / (10 + 8 * 1024) = .1%) to container_1371055675984_0001_01_000002.</p>
<p>If you run `top`, you should now see something like this:</p>
<script src="https://gist.github.com/5784993.js"> </script><p>As you can see, the <span class="caps">CPU</span> usage for <span class="caps">PID</span> 16708 is at 2.3%, while all of the others are maxing out near 100%! If you were to set the cpu.shares back to 1024, you&#8217;d see that the process once again gets its fair share.</p>
<h5>CGroups in Code</h5>
<p>Now that we&#8217;ve shown that Cgroups can work manually, you&#8217;ll probably want to update your <span class="caps">YARN</span> code to actually use them. This part is pretty trivial. You just need to call the setVirtualCores method on the <a href="http://hadoop.apache.org/docs/current/api/org/apache/hadoop/yarn/api/records/Resource.html">Resource</a> class when making container resource requests in <span class="caps">YARN</span>.</p>
<p>Make sure that whatever you request is within the minimum and maximum vcore boundaries defined in <a href="http://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-common/yarn-default.xml">yarn-default.xml</a>.</p>
<h5>Bumps in the Road</h5>
<p>Here are some problems that I encountered, along the way.</p>

	<ol>
		<li><span class="caps">YARN</span> was not updating cpu.shares. This is fixed in <span class="caps">YARN</span>-600.</li>
		<li>Invalid argument exception when AM starts up. This is triggered by the container-executor, and is fixed in <span class="caps">YARN</span>-799.</li>
		<li><span class="caps">YARN</span> AM was failing to localize. This is because the usercache directory that <span class="caps">YARN</span> uses was owned by the <span class="caps">YARN</span> NM username. When switching to <span class="caps">LCE</span>, that directory must be owned by the user running the job. Deleting usercache entirely and restarting the <span class="caps">YARN</span> NMs solved the problem.</li>
		<li><span class="caps">YARN</span> ignoring my container-executor.cfg file. It turns out that, by default, container-executor is hard-coded to use ../etc/hadoop/container-executor.cfg. If you want to put your container-executor elsewhere, you&#8217;ll need to re-build container executor.</li>
	</ol><script src="https://gist.github.com/5785113.js"> </script><p>When running the code initially, I was getting an &#8220;invalid argument&#8221; error when my <span class="caps">YARN</span> AM started. This turns out to be triggered when <span class="caps">YARN</span> tries to write to /cgroup/cpu/hadoop-yarn/container_id/cgroup.procs. This file was initially read-only, and only recently, in the Linux kernel, has it become read-write. There is a Jira open (<span class="caps">YARN</span>-799) to resolve this.</p>
</div>

<div class="text-blob">
  <div>
    <div style="float: right;">
      
    </div>
    
    <div>
      
      <a href="/posts/social/2012-10-22-tech-exits-what-you-should-know" title="After a long drought, some tech companies in the Valley (and abroad) are opting to file for IPOs. Meanwhile, goliaths like Google, Facebook, and Twitter are scooping up smaller startups in acquisitions. I thought it might be worth sharing some things that are worth knowing if you work in the valley.">&laquo; Tech Exits: What You Should Know</a>
      
    </div>
  </div>
</div>


          </div>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.8.0.min.js"><\/script>')</script>
        <script src="/js/plugins.js"></script>
        <script src="/js/main.js"></script>

        
    </body>
</html>
