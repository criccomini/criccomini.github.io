<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Killing Subprocesses in Linux/Bash</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        
        <link rel="stylesheet" href="/css/normalize.css">
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="/css/blog.css">
        <script src="/js/vendor/modernizr-2.6.1.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        
        <div class="content">
          <div class="col">
            <div class="text-blob" style="background-color: #34424D; color: white;">
              <div style="font-size: 2em; text-align: center;">
                <a style="color: white; text-decoration: none;" href="/">riccomini.name</a>
              </div>
            </div>
            <div class="text-blob">
              <a title="BlackBerry Storm, GPS, etc." href="/posts/blackberry">BlackBerry</a> <span style="color: #bbb;">7</span><br/>
              <a title="Data visualization and infographics" href="/posts/data-visualization">Data Visualization</a> <span style="color: #bbb;">1</span><br/>
              <a title="iPhone, Python, Operations, and Sports" href="/posts/game-time-baby">Game Time, Baby!</a> <span style="color: #bbb;">1</span><br/>
              <a title="Hadoop, Map/Reduce, Pig, and Hive" href="/posts/hadoop">Hadoop</a> <span style="color: #bbb;">5</span><br/>
              <a title="iPhone Objective C, and tutorials" href="/posts/iphone">iPhone</a> <span style="color: #bbb;">2</span><br/>
              <a title="Kafka, stream processing, Storm, and S4" href="/posts/kafka">Kafka</a> <span style="color: #bbb;">1</span><br/>
              <a title="Linux, and BASH" href="/posts/linux">Linux</a> <span style="color: #bbb;">1</span><br/>
              <a title="Python, PyFacebook, and Google App Engine" href="/posts/python">Python</a> <span style="color: #bbb;">1</span><br/>
              <a title="Twitter, Facebook, and LinkedIn" href="/posts/social">Social</a> <span style="color: #bbb;">5</span>
            </div>
            <div class="text-blob">
              <h4>Who</h4>

              <p>I am a software engineer in Silicon Valley.</p>

              <h4>About</h4>

              <p>My interests include distributed computing, data mining, programming, data visualization, and the social web.</p>
            </div>
            <div class="text-blob">
              <a href="/rss.xml"><img src="/img/rss.png"/></a>
              <a href="http://www.linkedin.com/in/riccomini"><img src="/img/linkedin.png"/></a>
              <a href="http://twitter.com/criccomini"><img src="/img/twitter.png"/></a>
              <a href="http://github.com/criccomini"><img src="/img/github.png"/></a>
            </div>
            
          </div>
          <div class="two-col">
            <div class="text-blob">
  <h2 style="color: #2E8AD1;">Killing Subprocesses in Linux/Bash</h2>
  <div style="font-size: .7em; color: #bbb;">25 Sep 2012</div>
  <p>A common requirement when writing Bash scripts in Linux is to kill all a process and all of its child that were spawned. This tutorial describes various methods to prevent orphaned subprocesses.</p>
  <p>Lately, I&#8217;ve been working with <a href="http://hadoop.apache.org/docs/r0.23.0/hadoop-yarn/hadoop-yarn-site/YARN.html"><span class="caps">YARN</span></a> at LinkedIn. This framework allows you to execute Bash scripts on one or more machines. It&#8217;s used primarily for Hadoop. When using <span class="caps">YARN</span>, you often end up with nested Bash scripts with no parent process ID (<span class="caps">PPID</span>) when the NodeManager launches the Bash script. This can be pretty problematic when the NodeManager is shut down, since you must make sure to clean up all child subprocesses via your parent Bash script.</p>
<h5>Understanding Linux Subprocesses</h5>
<p>Let&#8217;s start with an example. We&#8217;ll have two shell scripts: a parent, and a child:</p>
<pre><code>$ cat parent.sh 
#!/bin/bash
./child.sh</code></pre>
<pre><code>$ cat child.sh 
#!/bin/bash
sleep 1000</code></pre>
<p>Normally, when you launch nested processes from a terminal, you&#8217;ll see a process tree that looks something like this:</p>
<pre><code>UID        PID  PPID  C STIME  TTY         TIME CMD
ubuntu   10911 10701  0 05:07 pts/1    00:00:00 /bin/bash ./parent.sh
ubuntu   10912 10911  0 05:07 pts/1    00:00:00 /bin/bash ./child.sh
ubuntu   10913 10912  0 05:07 pts/1    00:00:00 sleep 1000</code></pre>
<p>In this example, a terminal (<span class="caps">PID</span> 10701) calls parent.sh, which calls child.sh, which calls sleep 1000. With <span class="caps">YARN</span>, you end up with a process tree that looks more like this:</p>
<pre><code>UID        PID  PPID  C STIME  TTY         TIME CMD
ubuntu   10966     1  0 05:14 pts/1    00:00:00 /bin/bash ./parent.sh
ubuntu   10967 10966  0 05:14 pts/1    00:00:00 /bin/bash ./child.sh
ubuntu   10968 10967  0 05:14 pts/1    00:00:00 sleep 1000</code></pre>
<p>Notice that the <span class="caps">PPID</span> of parent.sh is now 1. This is essentially a top-level process that has no parent.</p>
<h5>Unexpected Behavior</h5>
<p>In both of these examples, it seems intuitive that killing the top level parent would result in all of the children being cleaned up. There are a <a href="http://en.wikipedia.org/wiki/Kill_(command)">number of ways to kill a process</a>, so let&#8217;s start with:</p>
<pre><code>$ kill -9 10966</code></pre>
<pre><code>UID        PID  PPID  C STIME  TTY         TIME CMD
ubuntu   10966     1  0 05:14 pts/1    00:00:00 /bin/bash ./parent.sh
ubuntu   10967 10966  0 05:14 pts/1    00:00:00 /bin/bash ./child.sh
ubuntu   10968 10967  0 05:14 pts/1    00:00:00 sleep 1000</code></pre>
<p>As expected, killing the parent does not clean up any children:</p>
<pre><code>UID        PID  PPID  C STIME  TTY         TIME CMD
ubuntu   10967     1  0 05:14 pts/1    00:00:00 /bin/bash ./child.sh
ubuntu   10968 10967  0 05:14 pts/1    00:00:00 sleep 1000</code></pre>
<p>Let&#8217;s try sending a kill signal that&#8217;s not quite as strong as kill -9. For a list of possible signals, try running:</p>
<pre><code>$ kill -l
 1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP
 6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL     10) SIGUSR1
11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM
16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP
21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ
26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR
31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3
38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8
43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13
48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12
53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7
58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2
63) SIGRTMAX-1  64) SIGRTMAX</code></pre>
<p>Now, let&#8217;s try this again with a normal <a href="http://en.wikipedia.org/wiki/SIGHUP"><span class="caps">SIGHUP</span></a> kill. One might expect that sending such a soft kill signal should result in the child processes being cleaned up.</p>
<pre><code>$ kill -SIGHUP 10967</code></pre>
<pre><code>UID        PID  PPID  C STIME  TTY         TIME CMD
ubuntu   10968     1  0 05:14 pts/1    00:00:00 sleep 1000</code></pre>
<p>As you can see, even <span class="caps">SIGHUP</span> does not kill the child processes; it leaves the sleep call orphaned with a <span class="caps">PPID</span> of 1.</p>
<p>So, how can we do this properly?</p>
<h5>Traps</h5>
<p>One solution is to <a href="http://stackoverflow.com/questions/2525855/how-to-propagate-a-signal-through-an-arborescence-of-scripts-bash">use traps</a> in the Bash script. A trap is a way to say &#8220;do this before exiting&#8221; in a Bash script. For example, we might add the following line to parent.sh and child.sh:</p>
<pre><code>trap 'kill $(jobs -p)' EXIT</code></pre>
<p>Now, if we kill the parent, all children will be cleaned up! Obviously, this only works with softer kill signals, such as <span class="caps">SIGHUP</span>. For example, if we have this process tree:</p>
<pre><code>UID        PID  PPID  C STIME  TTY         TIME CMD
ubuntu   11049 10758  0 05:31 pts/2    00:00:00 /bin/bash ./parent.sh
ubuntu   11050 11049  0 05:31 pts/2    00:00:00 /bin/bash ./child.sh
ubuntu   11051 11050  0 05:31 pts/2    00:00:00 sleep 1000</code></pre>
<p>You can execute:</p>
<pre><code>$ kill 11049
$ ps -ef | grep sleep</code></pre>
<p>And you will see that sleep is no longer running!</p>
<h5>Top-Level Trap</h5>
<p>A variation of having a trap in each Bash file is to have a single top-level trap that uses &#8216;ps&#8217; to find children:</p>
<script src="https://gist.github.com/3786342.js"> </script><p>This is a less than ideal solution, but it does work. For details, see <a href="http://stas-blogspot.blogspot.com/2010/02/kill-all-child-processes-from-shell.html">this page</a>.</p>
<h5>Kill PPIDs</h5>
<p>Running traps everywhere can be kind of clunky, and error prone. A cleaner approach is to use the kill command, and provide a parent process ID (<span class="caps">PPID</span>) instead of a process ID. To do this, the syntax gets funky. You use a negative of the parent process ID, like so:</p>
<pre><code>kill -- -&lt;PPID&gt;</code></pre>
<p>For example, with this process tree:</p>
<pre><code>UID        PID  PPID  C STIME  TTY         TIME CMD
ubuntu   11096     1  0 05:36 ?        00:00:00 /bin/bash ./parent.sh
ubuntu   11097 11096  0 05:36 ?        00:00:00 /bin/bash ./child.sh
ubuntu   11098 11097  0 05:36 ?        00:00:00 sleep 1000</code></pre>
<p>You would run:</p>
<pre><code>kill -- -11096
ps -ef | grep sleep</code></pre>
<p>As you can see, killing with a <span class="caps">PPID</span> automatically cleans all subprocesses, including nested subprocesses!</p>
<h5>exec</h5>
<p>Another handy trick is to use <a href="http://linux.die.net/man/3/exec">exec</a> when nesting Bash calls. Exec replaces the &#8220;current&#8221; process with the &#8220;child&#8221; process. This doesn&#8217;t always work, but for our example (parent, child, sleep), it certainly does. Let&#8217;s make parent and child look like this, respectively:</p>
<pre><code>$ cat parent.sh
#!/bin/bash
exec ./child.sh</code></pre>
<pre><code>$ cat child.sh
#!/bin/bash
exec sleep 1000</code></pre>
<p>Notice the &#8220;exec&#8221; command preceding the child.sh and sleep calls. Let&#8217;s have a look at the process tree:</p>
<pre><code>$ ps -ef | grep parent
$ ps -ef | grep child
$ ps -ef | grep sleep
ubuntu   11155 10758  0 05:41 pts/2    00:00:00 sleep 1000</code></pre>
<p>As you can see, only a &#8216;sleep&#8217; process exists. The parent.sh script &#8220;becomes&#8221; child.sh, and child.sh &#8220;becomes&#8221; sleep. This makes it very easy to clean up child processes, because there are none! To clean up, you simply kill the &#8216;sleep&#8217; process. This is the method that I use with <span class="caps">YARN</span>, since I&#8217;m executing nested Bash calls that lead to a single Java process.</p>
<h5>Python</h5>
<p>If you&#8217;re not strictly tied to Bash, you might be interested in Python&#8217;s <a href="http://code.google.com/p/psutil/">psutil</a> library. It <a href="http://stackoverflow.com/questions/1230669/subprocess-deleting-child-processes-in-windows">can be used to kill all subprocess</a> for a given process ID.</p>
<h5>setsid</h5>
<p>One other minor note. You might be wondering how you end up with a <span class="caps">PPID</span> of 1. Obviously, kill -9&#8217;ing will do it. You can also use a command called <a href="http://linux.die.net/man/2/setsid">setsid</a>. This is what <span class="caps">YARN</span> does when its NodeManager executes a child process. To try and execute parent.sh with a <span class="caps">PPID</span> of 1, execute:</p>
<pre><code>setsid ./parent.sh</code></pre>
<p>For further reading, check the <a href="http://en.wikipedia.org/wiki/Nohup">nohup</a> wiki, which can be used as an alternative to setsid.</p>
</div>

<div class="text-blob">
  <div>
    <div style="float: right;">
      
      <a href="/posts/game-time-baby/2012-09-29-streaming-live-sports-schedule-scores-stats-api" title="One of my side projects ("Game Time, Baby!":http://getgametimebaby.com) required a way to programmatically load realtime live sports scores and schedules via an API. This page contains a rundown of the various options and services available.">Schedules & Scores API for Streaming Live Sports Stats &raquo; </a>
      
    </div>
    
    <div>
      
      <a href="/posts/hadoop/2010-03-27-hadoop-pig-sql-documentation" title="It is sometimes difficult for SQL users to learn Pig because their mind is used to working in SQL. In this tutorial, examples of various SQL statements are shown, and then translated into Pig statements.">&laquo; Hadoop, Pig, and SQL</a>
      
    </div>
  </div>
</div>


          </div>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.8.0.min.js"><\/script>')</script>
        <script src="/js/plugins.js"></script>
        <script src="/js/main.js"></script>

        
    </body>
</html>
